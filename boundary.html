<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Municipality Address Check</title>

  <link rel="preconnect" href="https://maps.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://maps.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Lato', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f9; }
    h1 { font-size: 14px; font-weight: bold; text-align: left; width: 92%; max-width: 420px; margin: 6px auto; }
    .row { width: 92%; max-width: 420px; margin: 8px auto; display: grid; grid-template-columns: 1fr; gap: 8px; }
    .row label { font-size: 14px; font-weight: bold; }
    select, .row input { width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 8px; }
    .row input:focus, select:focus { outline: none; border: 1px solid #0073e6; }
    .row input.error { border-color: #d93025; }

    .map-container { width: 92%; max-width: 420px; height: 420px; margin: 10px auto; border-radius: 12px; overflow:hidden; background:#e5e7eb; position: relative; }
    #legendChip{ position:absolute; top:8px; left:8px; background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:0 1px 4px rgba(0,0,0,.12); }

    #result { margin-top: 10px; font-size: 14px; font-weight: bold; text-align: left; line-height: 1.6; padding: 10px; width: 92%; max-width: 420px; display: none; border-radius: 10px; margin: 10px auto; background: #ecfdf5; color: #065f46; }
    #result.outside { background: #fef2f2; color: #991b1b; }
    #result .small { font-weight: normal; font-size: 12px; color: #374151; }

    .button-container { width: 92%; max-width: 420px; margin: 12px auto; text-align: center; }
    .button { width: 100%; padding: 12px 20px; font-size: 14px; background-color: #22c55e; color: white; border: none; border-radius: 10px; cursor: pointer; text-align: center; }

    .popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; border-radius: 12px; text-align: left; width: 92%; max-width: 520px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,.18); z-index: 1300; }
    .sharebar { display:flex; gap:8px; margin-top:10px; }
    .sharebar a { flex:1; text-align:center; text-decoration:none; color:#fff; padding:10px; border-radius:10px; font-size:13px; }
    .wa{background:#25D366} .sms{background:#111827} .copy{background:#6b7280} .email{background:#2563eb}

    .header-wrapper { display:flex; align-items:center; justify-content:flex-end; width:92%; max-width:420px; margin:8px auto 0; }
    #hamburgerMenu { background:none; border:none; font-size:24px; cursor:pointer; color:#111; }
    #menuDropdown { display:none; position:absolute; right:4%; top:48px; background:#fff; border-radius:10px; padding:8px; box-shadow:0 4px 12px rgba(0,0,0,.15); min-width:230px; z-index:1000; }
    #menuDropdown ul { list-style:none; margin:0; padding:0; }
    #menuDropdown li { border-bottom:1px solid #e5e7eb; }
    #menuDropdown li:last-child { border-bottom:0; }
    #menuDropdown a { display:block; padding:10px 12px; color:#111; text-decoration:none; border-radius:6px; }
    #menuDropdown a:hover { background:#f3f4f6; }

    /* Consent alignment fix (mobile-safe) */
    .consent-wrap{ width:92%; max-width:420px; margin:8px auto; display:flex; align-items:flex-start; gap:10px; }
    .consent-wrap input[type="checkbox"]{ margin-top:2px; flex:0 0 auto; }
    .consent-wrap label{ font-size:14px; font-weight:normal; line-height:1.35; text-align:left; flex:1 1 auto; }

    .linkbar { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .linkbar a { flex:1 1 48%; text-align:center; text-decoration:none; color:#111; background:#fff; border:1px solid #e5e7eb; padding:10px; border-radius:10px; font-size:13px; }
    .linkbar a.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
      .login-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:9999px;background:#f3f4f6;border:1px solid #e5e7eb;color:#0ea5e9;font-weight:700;font-size:13px;letter-spacing:.02em;text-decoration:none;line-height:1;}
    .login-btn:hover{background:#e5e7eb;}
    .login-btn:focus-visible{outline:2px solid #93c5fd; outline-offset:2px;}
    .login-btn .arrow{font-size:14px;line-height:1;}
  </style>

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>
<body>
  <div class="header-wrapper">
    <a href="./login.html" class="login-btn" aria-label="Log in">
  LOG IN <span class="arrow" aria-hidden="true">‚ñ∏</span>
</a>

  </div>

  <h1 id="pageTitle">Check if Your Address is Within the Municipality</h1>

  <div class="row">
    <label for="citySelect">Select City:</label>
    <select id="citySelect" aria-label="Select municipality">
      <option value="homestead" selected>Homestead</option>
      <option value="floridacity">Florida City</option>
    </select>
    <input type="text" id="addressInput" placeholder="Enter address here" aria-label="Address" />
  </div>

  <div class="map-container">
    <div id="legendChip">City boundary</div>
    <div id="map-container" style="width:100%;height:100%"></div>
  </div>

  <div id="result" aria-live="polite"></div>

    <!-- PLEDGE FORM -->
  <form id="pledgeForm" novalidate>
    <!-- Hidden campaign ID (change per candidate) -->
    <input type="hidden" id="campaignId" value="HOM-2025-01" />

    <div class="row">
      <label for="nameInput">Enter your full name:</label>
      <input type="text" id="nameInput" placeholder="Your Name" required />
    </div>

    <div class="row">
      <label for="voterCountInput">How many registered voters live at this address?</label>
      <input type="number" id="voterCountInput" placeholder="Number of Voters" min="1" required />
    </div>

    <div class="row">
      <label for="phoneNumberInput">Enter your phone number (optional but helpful):</label>
      <input type="tel" id="phoneNumberInput" placeholder="(123) 456-7890" inputmode="tel" />
    </div>

    <!-- Optional: email field if you want it later -->
    <!--
    <div class="row">
      <label for="emailInput">Email (optional):</label>
      <input type="email" id="emailInput" placeholder="you@example.com" />
    </div>
    -->

    <div class="consent-wrap">
      <input type="checkbox" id="consentInline" required />
      <label for="consentInline">
        I agree to be contacted by this campaign about elections and voting.
      </label>
    </div>

    <div class="row">
      <label for="signatureInputMain">Your signature:</label>
      <input type="text" id="signatureInputMain" placeholder="Type your full name here" required />
    </div>

    <div class="button-container">
      <button type="submit" id="submitBtn" class="button">Pledge my support</button>
    </div>
  </form>


  <div id="thankYouPopup" class="popup" role="dialog" aria-modal="true">
    <h2>Thank You for Your Support!</h2>
    <p>Your commitment makes a difference! By pledging your support, you're helping shape the future of our community.</p>
    <h3 style="margin:10px 0 6px;">Next steps</h3>
    <ol style="padding-left:18px; margin:6px 0;">
      <li>Renew/request your Vote-by-Mail ballot.</li>
      <li>Invite 2 friends who live in your city to pledge.</li>
    </ol>
    <div style="margin-top:8px;">
      <div class="small" style="margin-bottom:6px;">Voter tools</div>
      <div class="linkbar">
        <a class="primary" href="https://www.miamidade.gov/global/elections/vote-by-mail.page?utm_source=pledge_popup" target="_blank">üì© Request / Renew VBM</a>
        <a href="https://registertovoteflorida.gov/home?utm_source=pledge_popup" target="_blank">‚úî Check Voter Status</a>
        <a href="https://www.vote.org/register-to-vote/?utm_source=pledge_popup" target="_blank">üìù Register to Vote</a>
      </div>
    </div>
    <div class="sharebar">
      <a href="#" class="wa" id="shareWa">WhatsApp</a>
      <a href="#" class="sms" id="shareSms">SMS</a>
      <a href="#" class="copy" id="shareCopy">Copy link</a>
      <a href="#" class="email" id="shareEmail">Email</a>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="button" id="closePopup">Close</button>
    </div>
  </div>

  <script>
    // Hamburger menu toggle (safe if elements not present)
    (function(){
      const btn = document.getElementById('hamburgerMenu');
      const dd = document.getElementById('menuDropdown');
      if(!btn || !dd) return;
      btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const open = dd.style.display === 'block';
        dd.style.display = open ? 'none' : 'block';
        dd.setAttribute('aria-hidden', open ? 'true' : 'false');
      });
      document.addEventListener('click', (e)=>{
        if (!dd.contains(e.target) && e.target !== btn){ dd.style.display='none'; dd.setAttribute('aria-hidden','true'); }
      });
    })();

    // --- Map + Boundaries ---
    let map, autocomplete, marker, geocoder;
    let boundaryGeoJSON = null;
    const cityCache = {};
    const polygons = {};

    const citySelect = document.getElementById('citySelect');
    const addressInput = document.getElementById('addressInput');
    const resultEl = document.getElementById('result');
    const popup = document.getElementById('thankYouPopup');
    const closePopup = document.getElementById('closePopup');
    const shareWa = document.getElementById('shareWa');
    const shareSms = document.getElementById('shareSms');
    const shareCopy = document.getElementById('shareCopy');
    const shareEmail = document.getElementById('shareEmail');
    const legendChip = document.getElementById('legendChip');

        // Backend endpoint placeholder (we'll wire this in Step 2)
    const API_URL = 'https://script.google.com/macros/s/AKfycbxYOURREALIDHERE/exec';


    // Pledge form elements
    const pledgeForm = document.getElementById('pledgeForm');
    const campaignIdInput = document.getElementById('campaignId');
    const nameInput = document.getElementById('nameInput');
    const voterCountInput = document.getElementById('voterCountInput');
    const phoneNumberInput = document.getElementById('phoneNumberInput');
    const consentInline = document.getElementById('consentInline');
    const signatureInputMain = document.getElementById('signatureInputMain');
    const submitBtn = document.getElementById('submitBtn');
    // const emailInput = document.getElementById('emailInput'); // if you enable the email field

    const CITY_CONFIG = {
      homestead:   { name:'Homestead',    file:'./homestead_boundary.geojson',   center:{lat:25.4687,lng:-80.4776}, style:{stroke:'#ef4444', fill:'#ef4444'} },
      floridacity: { name:'Florida City', file:'./floridacity_boundary.geojson', center:{lat:25.4477,lng:-80.4809}, style:{stroke:'#0ea5e9', fill:'#0ea5e9'} }
    };

    function toLatLng(path){ return path.map(([lng, lat]) => ({ lat, lng })); }

    async function loadBoundary(city){
      if (cityCache[city]) return cityCache[city];
      const cfg = CITY_CONFIG[city];
      const res = await fetch(cfg.file, { cache:'no-store' });
      const raw = await res.json();
      let feature = raw.type==='FeatureCollection'? raw.features[0] : raw;
      cityCache[city] = feature;
      return feature;
    }

    function drawPolygonForCity(city){
      if (polygons[city]) { polygons[city].setMap(null); delete polygons[city]; }
      const feature = cityCache[city]; if (!feature) return;
      const g = feature.geometry; const cfg = CITY_CONFIG[city];
      const add = (coords) => {
        const latlngRings = coords.map(r => toLatLng(r));
        const poly = new google.maps.Polygon({
          paths: latlngRings,
          strokeColor: cfg.style.stroke, strokeOpacity: 1, strokeWeight: 2,
          fillColor: cfg.style.fill, fillOpacity: 0.18
        });
        poly.setMap(map);
        polygons[city] = poly;
      };
      if (g.type === 'Polygon') add(g.coordinates);
      else if (g.type === 'MultiPolygon') g.coordinates.forEach(add);
    }

    function fitBoundsToFeature(feature){
      const bounds = new google.maps.LatLngBounds();
      const g = feature.geometry;
      const add = (coords) => { toLatLng(coords[0]).forEach(pt => bounds.extend(pt)); };
      if (g.type === 'Polygon') add(g.coordinates);
      else if (g.type === 'MultiPolygon') g.coordinates.forEach(add);
      if (!bounds.isEmpty()) map.fitBounds(bounds);
    }

    function pointInPolygon(latLng, feature){
      const pt = turf.point([latLng.lng(), latLng.lat()]);
      const g = feature.geometry;
      if(g.type==='Polygon') return turf.booleanPointInPolygon(pt, turf.polygon(g.coordinates), {ignoreBoundary:false});
      if(g.type==='MultiPolygon') return turf.booleanPointInPolygon(pt, turf.multiPolygon(g.coordinates), {ignoreBoundary:false});
      return false;
    }

    function outsideCTA(cityName, otherCityDetected, otherCityKey){
      const otherText = otherCityDetected
        ? `<div class="small">This address appears to be in <strong>${CITY_CONFIG[otherCityKey].name}</strong>. <a href="#" id="switchCityLink">Switch to ${CITY_CONFIG[otherCityKey].name}</a>.</div>`
        : '';
      return `
        <div><strong>No ‚Äî this address is not within ${cityName}.</strong></div>
        ${otherText}
        <ul style="margin:8px 0 6px 18px; padding:0; font-weight:normal;">
          <li><strong>Know 2 people in ${cityName}?</strong> Share this page with them now.</li>
          <li><strong>Get involved:</strong> help with door-knocking, phone banks, or events.</li>
        </ul>
        <div class="sharebar" id="sharebarOutside">
          <a href="#" class="wa" id="shareWaOut">WhatsApp</a>
          <a href="#" class="sms" id="shareSmsOut">SMS</a>
          <a href="#" class="copy" id="shareCopyOut">Copy link</a>
          <a href="#" class="email" id="shareEmailOut">Email</a>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <a href="#" id="volunteerLink" style="flex:1; text-decoration:none; display:inline-block; padding:10px 14px; border-radius:10px; text-align:center; background:#22c55e; color:#fff;">Volunteer</a>
          <a href="https://www.vote.org/register-to-vote/" target="_blank" style="flex:1; text-decoration:none; display:inline-block; padding:10px 14px; border-radius:10px; text-align:center; background:#2563eb; color:#fff;">Get updates</a>
        </div>
      `;
    }

    function wireOutsideShare(cityName){
      // generate a simple referral code for tracking
      const shortId = Math.random().toString(36).slice(2,8);
      const base = location.href.split('#')[0];
      const shareUrl = `${base}?ref=pledge-${shortId}`;
      const msg = `I just checked my address. If you live in ${cityName}, can you pledge your support?`;

      const wa = document.getElementById('shareWaOut');
      const sms = document.getElementById('shareSmsOut');
      const cp = document.getElementById('shareCopyOut');
      const em = document.getElementById('shareEmailOut');
      if (!wa || !sms || !cp || !em) return;

      wa.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg+' '+shareUrl)}`;
      sms.href = `sms:?&body=${encodeURIComponent(msg+' '+shareUrl)}`;

      // ‚¨áÔ∏è Copy button: ONLY the URL
      cp.onclick = (e)=>{ e.preventDefault(); navigator.clipboard.writeText(shareUrl); alert('Link copied'); };

      em.href = `mailto:?subject=${encodeURIComponent('Support ' + cityName)}&body=${encodeURIComponent(msg+' '+shareUrl)}`;

      const vol = document.getElementById('volunteerLink');
      if (vol) vol.href = 'https://example.com/volunteer'; // TODO: replace with your volunteer form URL
    }

    function showInside(cityName){
      resultEl.style.display='block';
      resultEl.classList.remove('outside');
      resultEl.innerHTML = `
        <div><strong>Yes! Your address is in ${cityName}.</strong></div>
        <div class="small">Please answer the questions below the map.</div>
      `;
    }

    function showOutside(cityName, otherCityDetected=false, otherCityKey=null){
      resultEl.style.display='block';
      resultEl.classList.add('outside');
      resultEl.innerHTML = outsideCTA(cityName, otherCityDetected, otherCityKey);
      wireOutsideShare(cityName);
      if (otherCityDetected){
        const link = document.getElementById('switchCityLink');
        if (link){
          link.addEventListener('click', async (e)=>{
            e.preventDefault();
            citySelect.value = otherCityKey;
            await renderForCity(otherCityKey);
            resultEl.style.display='none';
          });
        }
      }
    }

    async function renderForCity(city, {fit=true}={}){
      const feature = await loadBoundary(city);
      boundaryGeoJSON = feature;
      drawPolygonForCity(city);
      legendChip.textContent = `${CITY_CONFIG[city].name} boundary`;
      const other = (city === 'homestead') ? 'floridacity' : 'homestead';
      if (polygons[other]) { polygons[other].setMap(null); delete polygons[other]; }
      if (fit) fitBoundsToFeature(feature);
    }

    function displayResults(latLng){
      if (!boundaryGeoJSON) return;
      const selected = citySelect.value;
      const other = selected === 'homestead' ? 'floridacity' : 'homestead';
      const inSelected = pointInPolygon(latLng, cityCache[selected]);

      if (inSelected){
        showInside(CITY_CONFIG[selected].name);
      } else {
        (async ()=>{
          const otherFeat = await loadBoundary(other);
          const inOther = pointInPolygon(latLng, otherFeat);
          if (inOther){
            showOutside(CITY_CONFIG[selected].name, true, other);
          } else {
            showOutside(CITY_CONFIG[selected].name, false, null);
          }
        })();
      }

      if (!marker) marker = new google.maps.Marker({ position: latLng, map, title: 'Checked address' });
      else marker.setPosition(latLng);
      map.setCenter(latLng);
      map.setZoom(15);
    }

    // Share popup (after pledge)
    function openPopup(){ popup.style.display = 'block'; }
    closePopup.addEventListener('click', ()=> popup.style.display='none');
    function openShare(){
      const cityName = CITY_CONFIG[citySelect.value].name;
      const msg = `Pledge your support if you live in ${cityName}:`;
      const url = location.href.split('#')[0];

      shareWa.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg + ' ' + url)}`;
      shareSms.href = `sms:?&body=${encodeURIComponent(msg + ' ' + url)}`;

      // ‚¨áÔ∏è Copy button: ONLY the URL
      shareCopy.onclick = (e)=>{ e.preventDefault(); navigator.clipboard.writeText(url); alert('Link copied'); };

      shareEmail.href = `mailto:?subject=${encodeURIComponent('Pledge for ' + cityName)}&body=${encodeURIComponent(msg + ' ' + url)}`;
      openPopup();
    }
        // Handle pledge submission
    pledgeForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Simple front-end validation
      let hasError = false;
      [nameInput, voterCountInput, signatureInputMain].forEach(input => {
        if (input && !input.value.trim()) {
          input.classList.add('error');
          hasError = true;
        } else if (input) {
          input.classList.remove('error');
        }
      });

      if (!consentInline.checked) {
        hasError = true;
        alert('Please confirm you agree to be contacted by the campaign.');
      }

      if (hasError) {
        return;
      }

      // Build full address string from UI
      const fullAddress = addressInput.value.trim();
      const cityKey = citySelect.value;
      const cityName = CITY_CONFIG[cityKey].name;

      const payload = {
        action: 'createPledge',
        campaign_id: campaignIdInput.value,
        supporter_full_name: nameInput.value.trim(),
        full_address: fullAddress,
        city_key: cityKey,
        city_display: cityName,
        voters_at_address: voterCountInput.value,
        phone: phoneNumberInput.value.trim(),
        consent: consentInline.checked,
        signature: signatureInputMain.value.trim(),
        source: 'Web form'
        // email: emailInput ? emailInput.value.trim() : ''
      };

      // For now, just log it so you can confirm it's structured correctly
      console.log('Pledge payload ready:', payload);

            // Send this to Google Sheets backend (Apps Script)
      try {
        await fetch(API_URL, {
          method: 'POST',
          // text/plain avoids some CORS preflight issues with Apps Script
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
      } catch (err) {
        console.error('Error sending pledge:', err);
      }

      */

      // Clear form & show thank-you popup
      pledgeForm.reset();
      openShare();
    });

    // Google Maps init
    async function initMap(){
      map = new google.maps.Map(document.getElementById('map-container'), {
        center:{lat:25.4687,lng:-80.4776}, zoom:13, mapTypeControl:false, streetViewControl:false
      });
      autocomplete = new google.maps.places.Autocomplete(addressInput, { types: ['address'], componentRestrictions:{ country:'us' } });
      geocoder = new google.maps.Geocoder();

      // Initial city boundary overlay
      await renderForCity(citySelect.value);

      autocomplete.addListener('place_changed', async ()=>{
        const place = autocomplete.getPlace();
        if(place?.geometry){
          displayResults(place.geometry.location);
        } else {
          resultEl.style.display='block';
          resultEl.classList.add('outside');
          resultEl.textContent = 'No details available for that address.';
        }
      });

      addressInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' && addressInput.value.trim()){
          geocoder.geocode({ address: addressInput.value.trim(), componentRestrictions:{ country:'US' } }, (results, status)=>{
            if(status==='OK' && results[0]){
              displayResults(results[0].geometry.location);
            } else {
              resultEl.style.display='block';
              resultEl.classList.add('outside');
              resultEl.textContent = 'Could not geocode that address. Please select from the suggestions.';
            }
          });
        }
      });

      citySelect.addEventListener('change', async ()=>{
        await renderForCity(citySelect.value);
        resultEl.style.display='none';
      });
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAShTpkHyffGlSUWQ9ttWxAVprwj6vUEQo&libraries=places&callback=initMap"></script>
</body>
</html>



























































