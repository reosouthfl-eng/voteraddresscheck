<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Homestead Voter Boundary Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <style>
    body{font-family:'Lato',sans-serif;margin:0;background:#f4f4f9;display:flex;flex-direction:column;align-items:center}
    h1{font-size:18px;margin:1rem auto;text-align:center}
    .input-container{width:90%;max-width:400px;margin:.5rem auto;display:flex;flex-direction:column}
    .input-container input{padding:.6rem;border:1px solid #ccc;border-radius:4px}
    .map-container{width:90%;max-width:400px;height:400px;margin:1rem auto}
    #result{display:none;width:90%;max-width:400px;margin:1rem auto;padding:.75rem;border-radius:8px;font-weight:700}
    #result.ok{background:#ecfdf5;color:#065f46}
    #result.out{background:#fef2f2;color:#991b1b}
    .button-container{width:90%;max-width:400px;margin:1rem auto;text-align:center}
    button{width:100%;padding:.75rem;border:none;border-radius:4px;background:#0069d9;color:#fff;font-size:1rem;cursor:pointer}
    #progressWrapper{width:90%;max-width:400px;margin:1rem auto;background:#ddd;border-radius:4px;overflow:hidden}
    #progressBar{height:16px;width:0;background:#28a745}
    #progressText{text-align:center;font-size:14px;margin-top:.25rem}
    .popup{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;padding:1rem;width:90%;max-width:500px;box-shadow:0 4px 8px rgba(0,0,0,.2)}
  </style>

  <!-- Turf for polygon math -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>
<body>
  <h1>Check if Your Address is Inside Homestead</h1>

  <div class="input-container">
    <label for="address">Address</label>
    <input id="address" type="text" placeholder="123 Main St" />
  </div>

  <div id="result"></div>
  <div id="map" class="map-container"></div>

  <div class="input-container">
    <label for="name">Your Name</label>
    <input id="name" type="text" />
  </div>
  <div class="input-container">
    <label for="count">How Many Voters at This Address?</label>
    <input id="count" type="number" min="1" />
  </div>
  <div class="input-container">
    <label for="phone">Phone (optional)</label>
    <input id="phone" type="tel" />
  </div>

  <div class="button-container">
    <button id="pledgeBtn">Pledge Support</button>
  </div>

  <!-- Candidate progress bar -->
  <div id="progressWrapper">
    <div id="progressBar"></div>
  </div>
  <div id="progressText">Loading progress…</div>

  <!-- Confirmation popup -->
  <div id="thankYou" class="popup">
    <h2>Thank You!</h2>
    <p>Your pledge has been recorded.</p>
    <div class="button-container">
      <button onclick="closePopup()">Close</button>
    </div>
  </div>

  <script>
    let map, marker, autocomplete, boundary, currentCityKey;

    const cityConfigs = {
      homestead: {
        name: "Homestead",
        geojson: "homestead_boundary.geojson",
        style: {
          strokeColor: "#FF0000",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#FF0000",
          fillOpacity: 0.15,
        },
      },
      floridaCity: {
        name: "Florida City",
        geojson: "floridacity_boundary.geojson",
        style: {
          strokeColor: "#0000FF",
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: "#0000FF",
          fillOpacity: 0.15,
        },
      },
    };

    async function loadCityBoundary(cityKey) {
      currentCityKey = cityKey;
      const config = cityConfigs[cityKey];
      const resp = await fetch(config.geojson);
      const geo = await resp.json();
      boundary = geo.features ? geo.features[0] : geo;
      const coords = boundary.geometry.coordinates[0].map(([lng, lat]) => ({ lat, lng }));
      new google.maps.Polygon({
        paths: coords,
        map,
        ...config.style,
      });
    }

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 25.47, lng: -80.48 },
        zoom: 12,
      });

      // Autocomplete input
      const input = document.getElementById("address");
      autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["address"],
        componentRestrictions: { country: "us" },
      });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          displayResults(false, "No details available for that address.");
          return;
        }
        checkPoint(place.geometry.location);
      });

      await loadCityBoundary("homestead");

      map.addListener("click", (e) => checkPoint(e.latLng));

      loadProgress();
    }

    function checkPoint(latLng) {
      if (!boundary) return;
      const point = turf.point([latLng.lng(), latLng.lat()]);
      const poly = turf.polygon(boundary.geometry.coordinates);
      const inside = turf.booleanPointInPolygon(point, poly);
      displayResults(inside);
      if (!marker) marker = new google.maps.Marker({ map });
      marker.setPosition(latLng);
      map.panTo(latLng);
      map.setZoom(15);
    }

    function displayResults(inside, msg) {
      const el = document.getElementById("result");
      el.style.display = "block";
      el.className = "";
      if (msg) {
        el.textContent = msg;
        return;
      }
      const cityName = cityConfigs[currentCityKey].name;
      if (inside) {
        el.classList.add("ok");
        el.textContent = `✔ Address is inside ${cityName}.`;
      } else {
        el.classList.add("out");
        el.textContent = `✘ Address is outside ${cityName}.`;
      }
    }

    document.getElementById("pledgeBtn").addEventListener("click", async () => {
      const name = document.getElementById("name").value.trim();
      const count = Number(document.getElementById("count").value);
      const phone = document.getElementById("phone").value.trim();
      if (!name || !count) {
        alert("Name and voter count are required.");
        return;
      }
      try {
        await fetch("/api/pledges", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, count, phone }),
        });
        openPopup();
        loadProgress();
      } catch {
        alert("Unable to record pledge.");
      }
    });

    function openPopup() {
      document.getElementById("thankYou").style.display = "block";
    }
    function closePopup() {
      document.getElementById("thankYou").style.display = "none";
    }

    async function loadProgress() {
      try {
        const res = await fetch("/api/pledges/progress");
        const data = await res.json();
        const pct = Math.min(100, (data.pledged / data.goal) * 100);
        document.getElementById("progressBar").style.width = pct + "%";
        document.getElementById("progressText").textContent =
          `${data.pledged} of ${data.goal} pledges`;
      } catch {
        document.getElementById("progressText").textContent = "Progress unavailable";
      }
    }
  </script>

  <!-- Google Maps API: replace YOUR_GOOGLE_MAPS_API_KEY -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap"></script>
</body>
</html>








